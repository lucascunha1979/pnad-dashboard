<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PNAD ContÃ­nua - Painel Interativo</title>
<script src="https://cdn.plot.ly/plotly-2.31.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
    body {font-family: 'Segoe UI', Roboto, sans-serif; background-color: #fafafa; margin: 0; padding: 20px;}
    h1 {text-align: center; color: #002b5c;}
    h2 {text-align: center; color: #555; margin-top: -10px;}
    #controls {text-align: center; margin-bottom: 25px;}
    select, input[type="radio"] {margin: 5px; padding: 5px;}
    #grafico {width: 95%; margin: auto;}
    #legendaGovernos {text-align: center; margin-top: 10px;}
    .legenda-item {display: inline-block; margin: 0 10px; padding: 5px 10px; border-radius: 5px; color: #fff;}
    table {width: 95%; margin: 20px auto; border-collapse: collapse; background: white; box-shadow: 0 0 8px rgba(0,0,0,0.1);}
    th {background: #002b5c; color: white; padding: 10px;}
    td {text-align: center; padding: 8px; border-bottom: 1px solid #ddd;}
    tr:hover {background-color: #f1f1f1;}
</style>
</head>
<body>
<h1>ðŸ“Š Painel Interativo: PNAD ContÃ­nua</h1>
<h2>Indicadores de Trabalho e Emprego - Brasil e Rio Grande do Sul</h2>

<div id="controls">
<label>VariÃ¡vel:</label>
<select id="variavel"></select>

<label>AbrangÃªncia:</label>
<input type="radio" name="abrangencia" value="Brasil" checked> Brasil
<input type="radio" name="abrangencia" value="Rio Grande do Sul"> RS

<label>PopulaÃ§Ã£o:</label>
<input type="radio" name="pop" value="Total" checked> Total
<input type="radio" name="pop" value="Homens"> Homens
<input type="radio" name="pop" value="Mulheres"> Mulheres
</div>

<div id="grafico"></div>
<div id="legendaGovernos"></div>

<h2>ðŸ“ˆ EstatÃ­sticas por Governo</h2>
<table id="tabela-estat">
<thead>
<tr>
<th>Governo</th><th>InÃ­cio</th><th>Fim</th><th>MÃ©dia</th>
<th>MÃ­nimo</th><th>MÃ¡ximo</th><th>VariaÃ§Ã£o (%)</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const governos = {
"Brasil": [
    {nome: "Dilma Rousseff (1Âº)", inicio: "2011-01-01", cor: "#d62728"},
    {nome: "Dilma Rousseff (2Âº)", inicio: "2015-01-01", cor: "#ff7f0e"},
    {nome: "Michel Temer", inicio: "2016-08-31", cor: "#1f77b4"},
    {nome: "Jair Bolsonaro", inicio: "2019-01-01", cor: "#2ca02c"},
    {nome: "Luiz InÃ¡cio Lula da Silva", inicio: "2023-01-01", cor: "#9467bd"}
],
"Rio Grande do Sul": [
    {nome: "Tarso Genro", inicio: "2011-01-01", cor: "#d62728"},
    {nome: "JosÃ© Ivo Sartori", inicio: "2015-01-01", cor: "#1f77b4"},
    {nome: "Eduardo Leite (1Âº)", inicio: "2019-01-01", cor: "#2ca02c"},
    {nome: "Ranolfo Vieira JÃºnior", inicio: "2022-03-31", cor: "#ff7f0e"},
    {nome: "Eduardo Leite (2Âº)", inicio: "2023-01-01", cor: "#9467bd"}
]
};

let dadosCSV;

Papa.parse("dados_pnad_trabalho.csv", {
    download: true,
    header: true,
    complete: function(results) {
        dadosCSV = results.data;
        popularVariaveis();
        atualizarGrafico();
    }
});

function popularVariaveis() {
    const select = document.getElementById("variavel");
    const vars = [...new Set(dadosCSV.map(d => d.variavel))].sort();
    vars.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.text = v;
        select.appendChild(opt);
    });
}

document.querySelectorAll("select, input[name='abrangencia'], input[name='pop']")
.forEach(el => el.addEventListener("change", atualizarGrafico));

function atualizarGrafico() {
    const variavel = document.getElementById("variavel").value;
    const abrangencia = document.querySelector("input[name='abrangencia']:checked").value;
    const pop = document.querySelector("input[name='pop']:checked").value;

    const df = dadosCSV.filter(d => 
        d.variavel === variavel && d.abrangencia === abrangencia &&
        d.pop === pop
    );

    const x = df.map(d => new Date(d.data_formatada));
    const y = df.map(d => parseFloat(Object.values(d).filter(v => !isNaN(v))[0])).filter(v => !isNaN(v));

    const media = y.length ? y.reduce((a,b)=>a+b,0)/y.length : null;
    const tendencia = y.length ? regressaoLinear(y) : [];

    const shapes = [];
    governos[abrangencia].forEach((g,i)=>{
        const x0 = new Date(g.inicio);
        const x1 = i < governos[abrangencia].length-1 ? new Date(governos[abrangencia][i+1].inicio) : new Date("2026-01-01");
        shapes.push({
            type:'rect',xref:'x',yref:'paper',x0,x1,y0:0,y1:1,
            fillcolor:g.cor,opacity:0.15,line:{width:0}
        });
    });

    const data = [{x, y, mode:'lines+markers', name:'Valor'}];
    if (media) data.push({x, y:Array(y.length).fill(media), mode:'lines', name:'MÃ©dia', line:{color:'blue',dash:'dot'}});
    if (tendencia.length) data.push({x, y:tendencia, mode:'lines', name:'TendÃªncia', line:{color:'red',dash:'dash'}});

    Plotly.newPlot("grafico", data, {
        title: `${abrangencia}: ${variavel}`,
        xaxis:{title:'PerÃ­odo'},
        yaxis:{title:'Valor'},
        shapes: shapes,
        height:600,
        template:'plotly_white'
    });

    gerarLegenda(abrangencia);
    atualizarTabela(df, abrangencia);
}

function regressaoLinear(y){
    const n=y.length, x=y.map((_,i)=>i);
    const meanX=x.reduce((a,b)=>a+b,0)/n, meanY=y.reduce((a,b)=>a+b,0)/n;
    const num=x.reduce((a,b,i)=>a+(b-meanX)*(y[i]-meanY),0);
    const den=x.reduce((a,b)=>a+(b-meanX)**2,0);
    const a=num/den, b=meanY-a*meanX;
    return x.map(v=>a*v+b);
}

function gerarLegenda(abrangencia){
    const div = document.getElementById("legendaGovernos");
    div.innerHTML = "";
    governos[abrangencia].forEach(g=>{
        const span = document.createElement("span");
        span.className = "legenda-item";
        span.style.backgroundColor = g.cor;
        span.textContent = g.nome;
        div.appendChild(span);
    });
}

function atualizarTabela(df, abrangencia){
    const corpo=document.querySelector("#tabela-estat tbody");
    corpo.innerHTML='';
    governos[abrangencia].forEach((g,i)=>{
        const ini=new Date(g.inicio);
        const fim=i<governos[abrangencia].length-1?new Date(governos[abrangencia][i+1].inicio):new Date("2026-01-01");
        const sub=df.filter(d=>{
            const data=new Date(d.data_formatada);
            return data>=ini && data<fim;
        });
        if(sub.length>0){
            const valores=sub.map(d=>parseFloat(Object.values(d).filter(v=>!isNaN(v))[0])).filter(v=>!isNaN(v));
            const media=mediaArray(valores);
            const min=Math.min(...valores);
            const max=Math.max(...valores);
            const variacao=((max-min)/min)*100;
            const linha=`<tr><td>${g.nome}</td><td>${ini.toISOString().slice(0,10)}</td>
                         <td>${fim.toISOString().slice(0,10)}</td><td>${media.toFixed(2)}</td>
                         <td>${min.toFixed(2)}</td><td>${max.toFixed(2)}</td>
                         <td>${variacao.toFixed(1)}%</td></tr>`;
            corpo.insertAdjacentHTML('beforeend',linha);
        }
    });
}

function mediaArray(arr){return arr.reduce((a,b)=>a+b,0)/arr.length;}
</script>
</body>
</html>